---
title: "RCT test output"
author: "Andreas Beger, Predictive Heuristics"
date: "4/2/2018"
output: 
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library("tidyverse")
library("forecast")
library("stringr")
```

# Are the base models estimating and without obvious mistakes?

```{r, warning=FALSE}
output_list <- dir("io", pattern = "_output_", full.names = TRUE)

summary_table <- list()
for (fh in output_list) {
  input_fh <- str_replace(fh, "output", "input")
  response <- jsonlite::fromJSON(fh, simplifyVector = TRUE, simplifyDataFrame = FALSE)
  request  <- jsonlite::fromJSON(input_fh)
  request_no <- str_extract(fh, "[0-9]+")
  
  this_ifp <- list()
  if (!is.null(response$message)) {
    err <- response$r_error_message %>% 
      str_replace_all(., "\\n", "") %>%
      str_replace_all(., "[ ]{2,}", " ") %>%
      str_replace_all(., " :", ":") %>%
      substr(., 10, 70)
    this_ifp <- data.frame(IFP = request_no, Model = "ARIMA", 
                           RMSE = NA, Estimated = 0, 
                           Error = err,
                           stringsAsFactors = FALSE)
  } else {
    this_ifp <- data.frame(IFP = request_no, Model = "ARIMA",  
                           RMSE = response$internal$rmse, Estimated = 1, 
                           Error = NA,
                           stringsAsFactors = FALSE)
  }
  this_ifp <- bind_rows(this_ifp)
  
  summary_table <- c(summary_table, list(this_ifp))
}
summary_table <- bind_rows(summary_table)
summary_table %>% 
  arrange(IFP) %>%
  knitr::kable(digits = 2)
```

```{r, warning = FALSE, fig.height=3, results = 'asis'}
output_list <- dir("io", pattern = "_output_", full.names = TRUE)

error_plot <- function(fcast, target, request_no, request) {
  y_pos <- (max(target$value, na.rm = TRUE) + mean(target$value, na.rm = TRUE)) / 2
  p <- ggplot(target, aes(x = date, y = value)) +
    geom_line() +
    theme_minimal() +
    ggtitle(sprintf("Request %s", request_no), subtitle = request$ifp$name) +
    labs(x = "", y = "") +
    geom_text(x = target$date[1], y = y_pos, col = "gray50",
              label = fcast$r_error_message %>% str_wrap(), hjust = 0)
  p
}

for (fh in output_list) {
  input_fh <- str_replace(fh, "output", "input")
  
  response <- jsonlite::fromJSON(fh, simplifyVector = TRUE, simplifyDataFrame = FALSE)
  request  <- jsonlite::fromJSON(input_fh)
  request_no <- str_extract(fh, "[0-9]+")
  
  cat(sprintf("\n\n## Request %s\n\n", request_no))
  cat(sprintf("\n\n %s \n\n", request$ifp$name))
  
  target <- data.frame(
    date  = as.Date(request$payload$historical_data$ts[, 1]),
    value = as.numeric(request$payload$historical_data$ts[, 2])
  )
  
  if (!is.null(response$message)) {
    p <- error_plot(response, target, request_no, request)
    print(p)
  } else {
    ff <- response
    fcast <- data.frame(
      date = as.Date(ff$ts[, 1]),
      mean = as.numeric(ff$ts[, 2]),
      lower = as.numeric(ff$ts[, 3]),
      upper = as.numeric(ff$ts[, 4])
    )
    
    h = nrow(fcast)
    target_i <- target %>% 
      tail(h*5 + 20) %>%
      gather(var, value, value)
    fcast_i <- fcast %>%
      gather(var, value, -date)
    df <- bind_rows(target_i, fcast_i) %>%
      spread(var, value)
    
    p <- ggplot(df, aes(x = date)) +
      geom_line(aes(y = value)) + 
      theme_minimal() +
      ggtitle(sprintf("Request %s, %s", request_no, ff$model)) +
      labs(x = "", y = "")
    # forecast is for single date, this does not plot with geom_ribbon
    if (nrow(fcast_i)==3) {
      p <- p + 
        geom_segment(aes(xend = date, y = lower, yend = upper), color = "lightblue") +
        geom_point(aes(y = mean), color = "blue")
    } else {
      p <- p + 
        geom_ribbon(aes(ymin = lower, ymax = upper), fill = "lightblue") +
        geom_line(aes(y = mean), color = "blue")
    }
    
    print(p)
  }
  
  cat("\n\n \\bigskip \n\n")
}
```


# Summary for all IFPs and models

```{r, warning=FALSE}
output_list <- dir("io", pattern = "_output_", full.names = TRUE)

summary_table <- list()
for (fh in output_list) {
  input_fh <- str_replace(fh, "output", "input")
  response <- jsonlite::fromJSON(fh, simplifyVector = TRUE, simplifyDataFrame = FALSE)
  request  <- jsonlite::fromJSON(input_fh)
  request_no <- str_extract(fh, "[0-9]+")
  
  this_ifp <- list()
  if (!is.null(response$message)) {
    this_ifp <- data.frame(IFP = request_no, Model = "All models", Estimated = 0, RMSE = NA)
  } else {
    for (model in response$forecasts) {
      this_model <- data.frame(IFP = request_no, Model = model$model)
      this_model$Estimated <- as.integer(is.null(model$message))
      this_model$RMSE <- model$internal$rmse
      this_ifp <- c(this_ifp, list(this_model))
    }
  }
  this_ifp <- bind_rows(this_ifp)
  
  summary_table <- c(summary_table, list(this_ifp))
}
summary_table <- bind_rows(summary_table)
summary_table %>% knitr::kable(digits = 2)
```

\clearpage

# Plot all forecasts

```{r, warning = FALSE, fig.height=3, results = 'asis'}
output_list <- dir("io", pattern = "_output_", full.names = TRUE)

error_plot <- function(fcast, target, request_no, request) {
  y_pos <- (max(target$value, na.rm = TRUE) + mean(target$value, na.rm = TRUE)) / 2
  p <- ggplot(target, aes(x = date, y = value)) +
    geom_line() +
    theme_minimal() +
    ggtitle(sprintf("Request %s", request_no), subtitle = request$ifp$name) +
    labs(x = "", y = "") +
    geom_text(x = target$date[1], y = y_pos, col = "gray50",
              label = fcast$r_error_message %>% str_wrap(), hjust = 0)
  p
}

for (fh in output_list) {
  input_fh <- str_replace(fh, "output", "input")
  
  response <- jsonlite::fromJSON(fh, simplifyVector = TRUE, simplifyDataFrame = FALSE)
  request  <- jsonlite::fromJSON(input_fh)
  request_no <- str_extract(fh, "[0-9]+")
  
  cat(sprintf("\n\n## Request %s\n\n", request_no))
  cat(sprintf("\n\n %s \n\n", request$ifp$name))
  
  target <- data.frame(
    date  = as.Date(request$payload$historical_data$ts[, 1]),
    value = as.numeric(request$payload$historical_data$ts[, 2])
  )
  
  if (!is.null(response$message)) {
    p <- error_plot(response, target, request_no, request)
    print(p)
  } else {
    # loop over forecasts and again, show error message if appropriate, else plot
    for (ff in response$forecasts) {
      
      if (!is.null(ff$message)) {
        p <- error_plot(ff, target, request_no, request)
        print(p)
      } else {
        
        fcast <- data.frame(
          date = as.Date(ff$ts[, 1]),
          mean = as.numeric(ff$ts[, 2]),
          lower = as.numeric(ff$ts[, 3]),
          upper = as.numeric(ff$ts[, 4])
        )
        
        h = nrow(fcast)
        target_i <- target %>% 
          tail(h*5 + 20) %>%
          gather(var, value, value)
        fcast_i <- fcast %>%
          gather(var, value, -date)
        df <- bind_rows(target_i, fcast_i) %>%
          spread(var, value)
        
        p <- ggplot(df, aes(x = date)) +
          geom_line(aes(y = value)) + 
          theme_minimal() +
          ggtitle(sprintf("Request %s, %s", request_no, ff$model)) +
          labs(x = "", y = "")
        # forecast is for single date, this does not plot with geom_ribbon
        if (nrow(fcast_i)==3) {
          p <- p + 
            geom_segment(aes(xend = date, y = lower, yend = upper), color = "lightblue") +
            geom_point(aes(y = mean), color = "blue")
        } else {
          p <- p + 
            geom_ribbon(aes(ymin = lower, ymax = upper), fill = "lightblue") +
            geom_line(aes(y = mean), color = "blue")
        }
        
        print(p)
      }
    }
  }
  
  cat("\n\n \\clearpage \n\n")
}
```



